# Документация: Функция create_shorts_with_blur_background

## Обзор

Функция `create_shorts_with_blur_background` предназначена для создания вертикальных видео (shorts) с размытым фоновым слоем из горизонтального или квадратного видео. Это позволяет конвертировать обычное видео в формат, подходящий для социальных сетей (например, Instagram Reels, YouTube Shorts, TikTok).

## Расположение

- **Файл**: `Components/Edit.py`
- **Строка**: 195-419
- **Импорт в main.py**: `from Components.Edit import create_shorts_with_blur_background`

## Сигнатура функции

```python
def create_shorts_with_blur_background(
    input_video_path: str,
    output_video_path: str,
    target_ratio_width: int = 213,
    target_ratio_height: int = 274
) -> bool:
```

### Параметры

- `input_video_path` (str): Путь к входному видео файлу
- `output_video_path` (str): Путь для сохранения результата
- `target_ratio_width` (int, опционально): Ширина целевого соотношения сторон (по умолчанию: 213)
- `target_ratio_height` (int, опционально): Высота целевого соотношения сторон (по умолчанию: 274)
- **Возвращает**: `bool` - True при успехе, False при ошибке

## Алгоритм работы

### 1. Получение размеров оригинального видео
- Использует `get_video_dimensions()` для определения ширины и высоты входного видео
- Вычисляет соотношение сторон оригинального видео

### 2. Расчет размеров финального видео
- Определяет размеры финального видео на основе целевого соотношения сторон
- Обеспечивает четные размеры для совместимости с кодеками

### 3. Создание основного видео
- Вырезает центральную часть оригинального видео
- Сохраняет пропорции основного контента
- Использует FFmpeg с высокими настройками качества (CRF 18)

### 4. Создание размытого фона
- Масштабирует оригинальное видео под финальные размеры
- Применяет адаптивное размытие (blur strength: 5-15, зависит от разрешения)
- Использует более низкое качество для фона (CRF 28)

### 5. Композиция финального видео
- Накладывает основное видео на размытый фон
- Центрирует основное видео в финальном кадре
- Сохраняет оригинальное аудио

## Технические характеристики

### Поддерживаемые форматы
- **Входные**: MP4, AVI, MOV, MKV (любые форматы, поддерживаемые FFmpeg)
- **Выходные**: MP4 с кодеком H.264

### Соотношения сторон
- **По умолчанию**: 213:274 (9:16 для вертикальных видео)
- **Настраиваемые**: Любые целые числа для ширины и высоты

### Качество обработки
- **Основное видео**: CRF 18 (высокое качество)
- **Фоновый слой**: CRF 28 (оптимизированное качество)
- **Финальное видео**: CRF 18 (высокое качество)

### Производительность
- **Временные файлы**: Автоматически создаются и удаляются
- **Память**: Эффективное использование временных файлов
- **Скорость**: Оптимизированные FFmpeg команды

## Зависимости

### Обязательные
- **FFmpeg**: Для обработки видео
- **Python libraries**:
  - `subprocess` (стандартная библиотека)
  - `tempfile` (стандартная библиотека)
  - `os`, `shutil` (стандартные библиотеки)

### Необязательные
- **ffprobe**: Для получения метаданных видео (входит в состав FFmpeg)

## Использование в пайплайне

Функция интегрирована в основной пайплайн обработки видео в `main.py`:

```python
# Включение в конфигурации
USE_BLUR_BACKGROUND_SHORTS = cfg.processing.use_blur_background_shorts

# Использование в process_highlight
if USE_BLUR_BACKGROUND_SHORTS:
    blur_success = create_shorts_with_blur_background(temp_segment, final_output_with_captions)
```

## Конфигурация

### В config.yaml
```yaml
processing:
  use_blur_background_shorts: false  # Включение/отключение функции
```

### В коде
```python
# В main.py
USE_BLUR_BACKGROUND_SHORTS = cfg.processing.use_blur_background_shorts
```

## Обработка ошибок

Функция включает комплексную обработку ошибок:

- **Проверка входных файлов**: Существование и доступность
- **FFmpeg ошибки**: Захват stdout/stderr для диагностики
- **Размеры видео**: Валидация полученных размеров
- **Временные файлы**: Очистка при ошибках
- **Исключения**: Полная трассировка стека для отладки

## Примеры использования

### Базовое использование
```python
from Components.Edit import create_shorts_with_blur_background

success = create_shorts_with_blur_background(
    input_video_path="input.mp4",
    output_video_path="output_shorts.mp4"
)
```

### С кастомным соотношением сторон
```python
success = create_shorts_with_blur_background(
    input_video_path="input.mp4",
    output_video_path="output_shorts.mp4",
    target_ratio_width=200,
    target_ratio_height=300
)
```

## Производительность

### Время обработки
- **Типичное время**: 30-120 секунд для 10-минутного видео
- **Факторы влияния**:
  - Разрешение оригинального видео
  - Сложность сцены (для размытия)
  - Производительность системы

### Оптимизации
- **Адаптивное размытие**: Интенсивность размытия зависит от разрешения
- **Параллельная обработка**: Возможность одновременной обработки нескольких сегментов
- **Оптимизированные кодеки**: Использование H.264 с оптимальными настройками

## Ограничения

1. **Форматы**: Ограничены форматами, поддерживаемыми FFmpeg
2. **Разрешение**: Рекомендуется HD и выше для лучших результатов
3. **Аудио**: Сохраняется только оригинальная аудиодорожка
4. **Метаданные**: Не сохраняются метаданные оригинального видео

## Совместимость

- **Операционные системы**: Windows, Linux, macOS
- **Python версии**: 3.7+
- **FFmpeg версии**: 4.0+

## Отладка и мониторинг

Функция включает подробное логирование:

- **Этапы обработки**: Информация о каждом шаге
- **Размеры видео**: Проверка на каждом этапе
- **Временные метки**: Измерение производительности
- **Ошибки FFmpeg**: Полные логи для диагностики

## Безопасность

- **Временные файлы**: Безопасное создание и удаление
- **Проверка путей**: Валидация входных и выходных путей
- **Обработка исключений**: Предотвращение сбоев системы

## Рекомендации по использованию

1. **Подготовка видео**: Используйте видео с разрешением не ниже 720p
2. **Тестирование**: Проверьте результат на небольшом сегменте перед обработкой длинных видео
3. **Хранилище**: Убедитесь в наличии достаточного места (2-3x от размера оригинала)
4. **FFmpeg**: Используйте последнюю стабильную версию

## Расширение функциональности

Функция может быть расширена для:

- Поддержки дополнительных форматов
- Кастомных эффектов размытия
- Множественных слоев
- Анимационных переходов
- Кастомных масок и форм

---

*Документация создана на основе анализа кода функции `create_shorts_with_blur_background` в файле `Components/Edit.py`*